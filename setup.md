# Setup Doc

## VM + Image

- 4 vCPU
- 4GB RAM
- 16GB HDD - Thin provisioned
- Fedora 36 Server 64-bit
- don't encrypt the drive
- no root account
- select: container, guest, headless options


## Configuration

- https://DOMAIN_NAME:9090
- Authenticate for admin access
- Install cockpit-pcp
- Enable monitoring
- Install all updates
- Enable automatic updates (only if restart works correctly)

### SSH Server

- Disable password authentication

```bash
sudo -i
vi /etc/ssh/sshd_config
systemctl restart sshd
exit
cd ~
mkdir .ssh
vi ~/.ssh/authorized_keys
```

```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMQ4IHasPwJ7L0zVp89n9v5SEAmuIFWiAb1nomtTXkXd lattmann.zsolt@gmail.com
```

### Apache Web Server

```bash
sudo -i

dnf install httpd httpd-tools mod_ssl 
systemctl start httpd
systemctl enable httpd

firewall-cmd --get-active-zones
firewall-cmd --zone=FedoraServer --permanent --add-service=http
firewall-cmd --zone=FedoraServer --permanent --add-service=https
firewall-cmd --zone=FedoraServer --permanent --list-services
firewall-cmd --reload
firewall-cmd --list-all
```

- Note: Need to do a full reboot to reload firewall configuration.

`vi /etc/httpd/conf.d/opening.app.lycophron.org.conf`

```conf
<VirtualHost *:80>
    #ServerAdmin admin@example.com
    ServerName opening.app.lycophron.org
    RewriteEngine on
    RewriteCond %{SERVER_NAME} =opening.app.lycophron.org
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>
```


```bash
dnf install python3-certbot-apache 
```


`vi /etc/httpd/conf.d/opening.app.lycophron.org-le-ssl.conf`

```conf
<IfModule mod_ssl.c>
<VirtualHost *:443>
    #ServerAdmin admin@example.com
    ServerName opening.app.lycophron.org

    ProxyPass "/" "http://localhost:8000/"
    ProxyPassReverse "/" "http://localhost:8000/"

    SetEnv force-proxy-request-1.0 1
    SetEnv proxy-nokeepalive 1

    <Location />
        AuthName "Private"
        AuthType Basic
        AuthBasicProvider dbm
        AuthDBMUserFile /usr/local/etc/httpd/.htdbm-users
        Require valid-user
    </Location>

    SSLCertificateFile /etc/letsencrypt/live/opening.app.lycophron.org/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/opening.app.lycophron.org/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>
```

```bash
sudo -i
httpd -t
systemctl restart httpd
mkdir /usr/local/etc/httpd
htdbm -c /usr/local/etc/httpd/.htdbm-users test-user-login
# add all users
htdbm -l /usr/local/etc/httpd/.htdbm-users

# for allowing proxying requests
setsebool -P httpd_can_network_connect 1

# set server name in /etc/httpd/conf/httpd.conf
dnf install goaccess

goaccess /var/log/httpd/access_log --log-format=COMBINED -a -o /var/www/html/report.html

sudo crontab -e
# runs every minute
* * * * * goaccess /var/log/httpd/access_log --log-format=COMBINED -a -o /var/www/html/report.html

exit
```


```bash
sudo dnf install cockpit-podman
#run as user
systemctl --user start podman
systemctl --user enable podman
systemctl start podman
systemctl enable podman

```

## Get Code

```bash
sudo dnf install git
mkdir GitHub
cd GitHub/
git clone git@github.com:lycophron/old.lycophron.git
cd old.lycophron/

# user space networking
sudo dnf install slirp4netns
podman build --tag old.lycophron -f ./Dockerfile
podman run -p 8000:8100 -d --name old.lycophron --rm --healthcheck-interval 1m --healthcheck-timeout 30s --healthcheck-start-period 0s --healthcheck-retries 3 --healthcheck-command "CMD-SHELL curl http://localhost:8100  || exit 1" old.lycophron

#must use create command
podman create -p 8000:8100 --name old.lycophron --rm --healthcheck-interval 1m --healthcheck-timeout 30s --healthcheck-start-period 0s --healthcheck-retries 3 --healthcheck-command "CMD-SHELL curl http://localhost:8100  || exit 1" old.lycophron

# https://linuxhandbook.com/autostart-podman-containers/
cd ~/.config/systemd/user/
podman generate systemd --name old.lycophron -f
systemctl --user enable container-old.lycophron.service
sudo loginctl enable-linger

firewall-cmd --zone=FedoraServer --permanent --add-port=8000/tcp
firewall-cmd --reload
```

```ini
# container-old.lycophron.service
# autogenerated by Podman 4.2.0
# Sun Aug 21 13:53:29 PDT 2022

[Unit]
Description=Podman container-old.lycophron.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=/run/user/1000/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStartPre=/usr/bin/bash /home/management/old.lycophron/unit-exec-start-pre.sh
ExecStart=/usr/bin/podman start old.lycophron
ExecStop=/usr/bin/podman stop -t 10 old.lycophron
ExecStopPost=/usr/bin/podman stop -t 10 old.lycophron
#PIDFile=/var/run/user/1000/containers/overlay-containers/9f8fa5f483b2430f572d17485bfb66eb6a931a69064ec1c1534f515076221258/userdata/conmon.pid
PIDFile=/var/run/user/1000/containers/myPID-old.lycophron-12345.pid
Type=forking

[Install]
WantedBy=default.target
```

